name: Ultimate Stable Android APK Build (Buildozer Action)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # Pin to a stable Ubuntu version for environment consistency
    runs-on: ubuntu-22.04 

    steps:
    - name: üì¶ Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Setup Python 3.8
      # Guarantees a stable Python environment (including necessary dev packages)
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'

    - name: ‚öôÔ∏è Install essential system dependencies and build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jdk-headless unzip wget ca-certificates
        
        # Set Java Home for the action's environment
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        
        # FIX: Install libtinfo5 for legacy NDK/SDK tool compatibility
        wget -q https://security.ubuntu.com/ubuntu/pool/universe/n/ncurses/libtinfo5_6.3-2ubuntu0.1_amd64.deb
        sudo apt install -y ./libtinfo5_6.3-2ubuntu0.1_amd64.deb || true
        rm -f libtinfo5_6.3-2ubuntu0.1_amd64.deb
        
        # Install Python build tools
        pip install --upgrade pip
        pip install buildozer cython kivy

    # üî® The Definitive Build Step
    - name: üî® Execute Buildozer (Final Integrated Action)
      # CRITICAL FIX 1: Use the specific stable version to avoid internal action bugs
      uses: ArtemSBulgakov/buildozer-action@v1.2.0 
      id: buildozer
      with:
        command: buildozer android debug
        workdir: . 
        buildozer_version: stable
      env:
        # CRITICAL FIX 2: Set numeric IDs to bypass the 'chown: invalid user: user' error
        # These UIDs/GIDs are valid for the GitHub Actions runner/Docker bridge.
        USER_ID: 1001 
        GROUP_ID: 121
        
    - name: ‚¨ÜÔ∏è Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: Classic_Pong_APK
        path: ./bin/*.apk
