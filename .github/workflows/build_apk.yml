# .github/workflows/build_apk.yml

name: Android APK Build (Buildozer)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì¶ Checkout Repository
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Workaround:Install libtinfo5 for Buildozer
      run: |
        sudo apt-get update
        # Fetch a compatible libtinfo5 package from Jammy (22.04) security repo
        wget https://security.ubuntu.com/ubuntu/pool/universe/n/ncurses/libtinfo5_6.3-2ubuntu0.1_amd64.deb
        sudo apt install -y ./libtinfo5_6.3-2ubuntu0.1_amd64.deb
        rm libtinfo5_6.3-2ubuntu0.1_amd64.deb

    - name: ‚úÖ Install Android SDK components (platform-tools, platforms, build-tools)
      # Ensure the SDK has the necessary packages so 'aidl' (and other tools) exist.
      # Adjust the platform / build-tools versions to match android.api in your buildozer.spec.
      run: |
        set -e
        # Ensure cmdline-tools exist (the buildozer-action normally sets ANDROID_SDK_ROOT)
        if [ -z "${ANDROID_SDK_ROOT:-}" ]; then
          echo "ANDROID_SDK_ROOT not set; printing PATH and environment for debugging"
          env
          exit 1
        fi
        SDK_MANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
        if [ ! -x "$SDK_MANAGER" ]; then
          echo "sdkmanager not found at $SDK_MANAGER; listing $ANDROID_SDK_ROOT"
          ls -la "$ANDROID_SDK_ROOT" || true
          exit 1
        fi
        # Install common tools; change or add versions to match buildozer.spec android.api
        yes | "$SDK_MANAGER" --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-30" "platforms;android-31" "build-tools;30.0.3" "build-tools;31.0.0"
        # Confirm aidl exists
        echo "Checking for aidl in build-tools:"
        ls -la "$ANDROID_SDK_ROOT/build-tools" || true
        find "$ANDROID_SDK_ROOT/build-tools" -maxdepth 2 -type f -name aidl -print || true

    - name: ‚úÖ Accept Android SDK Licenses
      run: |
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: üî® Build APK with Buildozer
      uses: digreatbrian/buildozer-action@v2
      id: buildozer
      with:
        buildozer-cmd: buildozer -v android debug
        work-dir: .
        python-version: 3.8

    - name: ‚¨ÜÔ∏è Upload Artifact (APK)
      uses: actions/upload-artifact@v4
      with:
        name: Classic_Pong_APK
        path: ./bin/*.apk
