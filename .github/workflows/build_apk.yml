name: Android APK Build (Buildozer)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # Define a consistent location for the Android SDK inside the runner's workspace
  ANDROID_SDK_ROOT: ${{ github.workspace }}/.android-sdk

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì¶ Checkout repository
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Install system deps and libtinfo5 workaround
      run: |
        # Install necessary build tools and Java
        sudo apt-get update
        sudo apt-get install -y unzip wget ca-certificates openjdk-11-jdk-headless
        
        # FIX 1: Install libtinfo5 from Jammy (needed for Buildozer/p4a on newer runners)
        wget -q https://security.ubuntu.com/ubuntu/pool/universe/n/ncurses/libtinfo5_6.3-2ubuntu0.1_amd64.deb
        sudo apt install -y ./libtinfo5_6.3-2ubuntu0.1_amd64.deb || true
        rm -f libtinfo5_6.3-2ubuntu0.1_amd64.deb
        
    - name: üîß Bootstrap Android cmdline-tools and sdkmanager
      # Manually set up the SDK root so sdkmanager exists for the next step.
      run: |
        set -euo pipefail
        mkdir -p "$ANDROID_SDK_ROOT"
        cd "$ANDROID_SDK_ROOT"
        
        # Download and extract commandlinetools
        CLI_TOOLS_Z="commandlinetools-linux-9477386_latest.zip"
        CLI_URL="https://dl.google.com/android/repository/${CLI_TOOLS_Z}"
        
        if [ ! -d "$ANDROID_SDK_ROOT/cmdline-tools/latest" ]; then
          wget -q "$CLI_URL" -O /tmp/cmdline-tools.zip
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          unzip -q /tmp/cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools/tmp"
          mv "$ANDROID_SDK_ROOT/cmdline-tools/tmp/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          rm -rf "$ANDROID_SDK_ROOT/cmdline-tools/tmp" /tmp/cmdline-tools.zip
        fi
        
        # Add sdkmanager to PATH for the next step
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

    - name: ‚úÖ Accept SDK licenses and install platform/build-tools (aidl)
      # FIX 2: Pre-install the necessary components and accept the licenses.
      run: |
        set -euo pipefail
        SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
        
        # Accept licenses non-interactively for this SDK root
        yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" --licenses
        
        # Install platform-tools, the platform, and build-tools (36.1.0 was requested in your logs)
        yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-36" "build-tools;36.1.0"
        
    - name: üîí Ensure ANDROID_HOME variables for Buildozer
      # Export the final paths and environment variables to be used by the subsequent action.
      run: |
        # Set environment variables for the current job
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        
        # Add necessary directories to the PATH for the action to find tools like aidl
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
        for d in "$ANDROID_SDK_ROOT"/build-tools/*; do
          if [ -d "$d" ]; then
            echo "$d" >> $GITHUB_PATH
          fi
        done

    - name: üî® Build APK with Buildozer
      # The action will now use the pre-configured ANDROID_SDK_ROOT and environment variables.
      uses: digreatbrian/buildozer-action@v2
      id: buildozer
      with:
        buildozer-cmd: buildozer -v android debug
        work-dir: .
        python-version: 3.8

    - name: ‚¨ÜÔ∏è Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: Classic_Pong_APK
        path: ./bin/*.apk
