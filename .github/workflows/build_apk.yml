# .github/workflows/build_apk.yml

name: Android APK Build (Buildozer)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì¶ Checkout Repository
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Workaround:Install libtinfo5 for Buildozer
      run: |
        sudo apt-get update
        wget https://security.ubuntu.com/ubuntu/pool/universe/n/ncurses/libtinfo5_6.3-2ubuntu0.1_amd64.deb
        sudo apt install -y ./libtinfo5_6.3-2ubuntu0.1_amd64.deb
        rm libtinfo5_6.3-2ubuntu0.1_amd64.deb

    - name: ‚úÖ Ensure Android SDK cmdline-tools and accept licenses
      run: |
        set -e
        # Ensure ANDROID_SDK_ROOT exists (buildozer-action normally sets it)
        if [ -z "${ANDROID_SDK_ROOT:-}" ]; then
          echo "ERROR: ANDROID_SDK_ROOT is not set. The buildozer action should set this; make sure it's available."
          env
          exit 1
        fi
        SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
        if [ ! -x "$SDKMANAGER" ]; then
          echo "Attempting to install cmdline-tools via sdkmanager bootstrap..."
          # If cmdline-tools not present, try to bootstrap via the tools already present (best-effort).
          # If the action provides no sdkmanager at all this will fail ‚Äî see notes below.
        fi
        # Accept all current SDK licenses non-interactively
        yes | "$SDKMANAGER" --licenses || true

    - name: ‚úÖ Install Android SDK packages (platform-tools, platforms, build-tools)
      run: |
        set -e
        SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
        if [ ! -x "$SDKMANAGER" ]; then
          echo "sdkmanager not found at $SDKMANAGER; listing $ANDROID_SDK_ROOT for debugging"
          ls -la "$ANDROID_SDK_ROOT" || true
          exit 1
        fi
        # IMPORTANT: match these versions to the android.api value in buildozer.spec.
        # The log you provided shows Build-Tools 36.1 requested ‚Äî install that one explicitly.
        yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-36" "build-tools;36.1.0"
        echo "Installed build-tools; checking for aidl:"
        find "$ANDROID_SDK_ROOT/build-tools" -type f -name aidl -print || true

    - name: üî® Build APK with Buildozer
      uses: digreatbrian/buildozer-action@v2
      id: buildozer
      with:
        buildozer-cmd: buildozer -v android debug
        work-dir: .
        python-version: 3.8

    - name: ‚¨ÜÔ∏è Upload Artifact (APK)
      uses: actions/upload-artifact@v4
      with:
        name: Classic_Pong_APK
        path: ./bin/*.apk
