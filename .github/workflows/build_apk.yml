name: Android APK Build (Buildozer)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # Define a consistent location for the Android SDK inside the runner's workspace
  ANDROID_SDK_ROOT: ${{ github.workspace }}/.android-sdk

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì¶ Checkout repository
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Install system deps, Java, Python & libtinfo5
      run: |
        # Set up Python 3.8
        sudo apt-get update
        sudo apt-get install -y python3.8 python3.8-distutils python3-pip openjdk-11-jdk-headless unzip wget ca-certificates
        sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 1
        
        # Install libtinfo5 fix
        wget -q https://security.ubuntu.com/ubuntu/pool/universe/n/ncurses/libtinfo5_6.3-2ubuntu0.1_amd64.deb
        sudo apt install -y ./libtinfo5_6.3-2ubuntu0.1_amd64.deb || true
        rm -f libtinfo5_6.3-2ubuntu0.1_amd64.deb
        
        # Install Buildozer and Kivy/Cython dependencies for the build
        pip3 install buildozer cython kivy
        
    - name: üîß Bootstrap Android cmdline-tools and sdkmanager
      # Manually set up the SDK root.
      run: |
        set -euo pipefail
        mkdir -p "$ANDROID_SDK_ROOT"
        cd "$ANDROID_SDK_ROOT"
        
        CLI_TOOLS_Z="commandlinetools-linux-9477386_latest.zip"
        CLI_URL="https://dl.google.com/android/repository/${CLI_TOOLS_Z}"
        
        if [ ! -d "$ANDROID_SDK_ROOT/cmdline-tools/latest" ]; then
          wget -q "$CLI_URL" -O /tmp/cmdline-tools.zip
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          unzip -q /tmp/cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools/tmp"
          mv "$ANDROID_SDK_ROOT/cmdline-tools/tmp/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          rm -rf "$ANDROID_SDK_ROOT/cmdline-tools/tmp" /tmp/cmdline-tools.zip
        fi
        
        # Add sdkmanager to PATH
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

    - name: ‚úÖ Accept SDK licenses and install platform/build-tools (aidl)
      run: |
        set -euo pipefail
        SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
        
        # Accept licenses
        yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" --licenses
        
        # Install tools
        yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-36" "build-tools;36.1.0"
        
    - name: üîí Finalize Environment Variables
      # Set ANDROID_HOME and PATH variables for the upcoming build command
      run: |
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        
        # Add build-tools to PATH so buildozer can find aidl/aapt
        for d in "$ANDROID_SDK_ROOT"/build-tools/*; do
          if [ -d "$d" ]; then
            echo "$d" >> $GITHUB_PATH
          fi
        done

    - name: üî® Execute Buildozer (Final Build)
      # Direct execution uses the fully provisioned environment
      run: |
        # Ensure JAVA_HOME is set for the build
        export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
        # Now run buildozer. It will use the environment variables we set.
        buildozer -v android debug

    - name: ‚¨ÜÔ∏è Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: Classic_Pong_APK
        path: ./bin/*.apk
