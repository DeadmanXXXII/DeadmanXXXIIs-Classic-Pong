name: Ultimate Stable Android APK Build (Buildozer Native)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # Pin to a stable Ubuntu version
    runs-on: ubuntu-22.04 

    steps:
    - name: üì¶ Checkout repository
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Install Essential Dependencies
      run: |
        sudo apt-get update
        # Install Python 3.8 development headers and a modern Java version (17 is now required by p4a)
        sudo apt-get install -y python3-pip python3.8-dev openjdk-17-jdk-headless unzip wget ca-certificates
        
        # Set Java Home environment variable for buildozer
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV 

        # FIX: Install libtinfo5 for legacy NDK/SDK tool compatibility
        wget -q https://security.ubuntu.com/ubuntu/pool/universe/n/ncurses/libtinfo5_6.3-2ubuntu0.1_amd64.deb
        sudo apt install -y ./libtinfo5_6.3-2ubuntu0.1_amd64.deb || true
        rm -f libtinfo5_6.3-2ubuntu0.1_amd64.deb
        
        # Install Buildozer and Kivy
        pip install --upgrade pip
        pip install buildozer cython kivy
        
    - name: üî® Execute Buildozer and Accept Licenses
      # This single step runs buildozer. Buildozer will download and install the SDK 
      # into its preferred path (~/.buildozer/android/), and the 'yes |' pipe 
      # automatically accepts all licenses, preventing the "Aidl not found" error.
      run: |
        yes | buildozer -v android debug --profile default
    
    - name: ‚¨ÜÔ∏è Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: Classic_Pong_APK
        path: ./bin/*.apk
